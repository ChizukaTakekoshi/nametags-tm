<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>名札スキャン（Teachable Machine）</title>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
</head>
<body>
  <h1>名札スキャン（Teachable Machine）</h1>
  <p>GitHub Pages から model.json / weights.bin / metadata.json を読み込みます。</p>

  <button type="button" onclick="init()">カメラ開始</button>
  <button type="button" onclick="stop()">停止</button>

  <div id="webcam-container"></div>
  <div id="label-container" style="margin-top: 10px; font-size: 1.5em; font-weight: bold;"></div>

  <script type="text/javascript">
    // モデルの置き場所（最後に / を付ける）
    const MODEL_URL = "https://chizukatakekoshi.github.io/nametags-tm/";

    let model, webcam, labelContainer, loopId;
    let fixedResult = null; // 一度確定したら保持
    const THRESHOLD = 0.5;  // 閾値（0.5以上で確定）

    async function init() {
      const modelURL = MODEL_URL + "model.json";
      const metadataURL = MODEL_URL + "metadata.json";
      model = await tmImage.load(modelURL, metadataURL);

      webcam = new tmImage.Webcam(400, 400, true); // flip: true
      await webcam.setup();
      await webcam.play();
      loopId = window.requestAnimationFrame(loop);

      document.getElementById("webcam-container").innerHTML = "";
      document.getElementById("webcam-container").appendChild(webcam.canvas);

      labelContainer = document.getElementById("label-container");
      labelContainer.innerHTML = "判定待ち…";
    }

    async function loop() {
      webcam.update();
      if (fixedResult === null) {
        await predict();
      }
      loopId = window.requestAnimationFrame(loop);
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);
      let best = prediction.reduce((prev, curr) =>
        prev.probability > curr.probability ? prev : curr
      );

      // 初めて閾値以上になったら確定
      if (best.probability >= THRESHOLD) {
        fixedResult = `${best.className} さん`;
        labelContainer.innerHTML = `判定結果: ${fixedResult}`;
      }
    }

    function stop() {
      if (loopId) {
        window.cancelAnimationFrame(loopId);
        loopId = null;
      }
      if (webcam) {
        webcam.stop();
      }
    }
  </script>
</body>
</html>

