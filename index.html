<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>名札スキャン（Teachable Machine）</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>
</head>
<body>
  <h1>名札スキャン（Teachable Machine）</h1>
  <p>GitHub Pages から model.json / weights.bin / metadata.json を読み込みます</p>
  <button onclick="init()">カメラ開始</button>
  <button onclick="stop()">停止</button>
  <div id="webcam-container"></div>
  <div id="label-container" style="margin-top: 10px; font-size: 1.5em; font-weight: bold;"></div>

  <script type="text/javascript">
    // モデルのパス（GitHub Pages URLに変更）
    const MODEL_URL = "https://chizukatakekoshi.github.io/nametags-tm/";

    let model, webcam, labelContainer, maxPredictions, loopId;

    async function init() {
      // モデルとメタデータの読み込み
      const modelURL = MODEL_URL + "model.json";
      const metadataURL = MODEL_URL + "metadata.json";
      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      // カメラ設定
      const flip = true;
      webcam = new tmImage.Webcam(400, 400, flip);
      await webcam.setup();
      await webcam.play();
      loopId = window.requestAnimationFrame(loop);

      document.getElementById("webcam-container").innerHTML = "";
      document.getElementById("webcam-container").appendChild(webcam.canvas);

      labelContainer = document.getElementById("label-container");
    }

    async function loop() {
      webcam.update();
      await predict();
      loopId = window.requestAnimationFrame(loop);
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);

      // 一番確率が高いクラスを選択
      let best = prediction.reduce((prev, curr) =>
        (prev.probability > curr.probability ? prev : curr)
      );

      // 1人だけ表示
      labelContainer.innerHTML = `判定: ${best.className} (${best.probability.toFixed(2)})`;
    }

    function stop() {
      if (loopId) {
        window.cancelAnimationFrame(loopId);
        loopId = null;
      }
      if (webcam) {
        webcam.stop();
      }
    }
  </script>
</body>
</html>
