<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>名札スキャン（Teachable Machine）</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>
</head>
<body>
  <h1>名札スキャン（Teachable Machine）</h1>
  <p>GitHub Pages から model.json / weights.bin / metadata.json を読み込みます</p>
  <button onclick="init()">カメラ開始</button>
  <button onclick="stop()">停止</button>
  <div id="webcam-container"></div>
  <div id="label-container" style="margin-top: 10px; font-size: 1.5em; font-weight: bold;"></div>

  <script type="text/javascript">
    const MODEL_URL = "https://chizukatakekoshi.github.io/nametags-tm/";
    let model, webcam, labelContainer, loopId;
    let fixedResult = null; // 判定を固定する変数

    async function init() {
      const modelURL = MODEL_URL + "model.json";
      const metadataURL = MODEL_URL + "metadata.json";
      model = await tmImage.load(modelURL, metadataURL);

      const flip = true;
      webcam = new tmImage.Webcam(400, 400, flip);
      await webcam.setup();
      await webcam.play();
      loopId = window.requestAnimationFrame(loop);

      document.getElementById("webcam-container").innerHTML = "";
      document.getElementById("webcam-container").appendChild(webcam.canvas);

      labelContainer = document.getElementById("label-container");
    }

    async function loop() {
      webcam.update();
      if (fixedResult === null) { // まだ確定していない場合のみ予測
        await predict();
      }
      loopId = window.requestAnimationFrame(loop);
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);
      let best = prediction.reduce((prev, curr) =>
        (prev.probability > curr.probability ? prev : curr)
      );

      // 確率が0.5以上なら即確定（閾値は調整可）
      if (best.probability >= 0.5) {
        fixedResult = `${best.className} (${best.probability.toFixed(2)})`;
        labelContainer.innerHTML = `判定: ${fixedResult}`;
      }
    }

    function stop() {
      if (loopId) {
        window.cancelAnimationFrame(loopId);
        loopId = null;
      }
      if (webcam) {
        webcam.stop();
      }
    }
  </script>
</body>
</html>

